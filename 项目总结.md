# NAIC 2022复赛项目总结

汇报人：高煜林
汇报日期：2022/3/23

## 大赛简介

### 复赛任务

包括 3 部分联合任务：行人/车辆视觉特征提取、行人/车辆视觉特征压缩编码以及行人/车辆重识别。

赛道主办方提供行人/车辆图像，选手需提取具有良好泛化性与语义抽象力的视觉特征，按规定的预设码率对该特征进行压缩和重建，并使用重建特征进行再识别任务，获得再识别任务性能得分。特征压缩超过预设码率视作无效。

选手对大赛提供的视觉特征进行压缩和重建，根据特征的重建误差得分。特征压缩超过预设码率视作无效。

复赛得分为重建误差得分和再识别任务性能得分的算术平均值。

选手得分相近的情况下，依据文档提供的模型算法先进性与计算复杂性的定量/定性分析进行排序。

单幅图像的特征压缩操作点（Operating Point）预设 3 个码率： 64 字节、 128 字节和 256 字节。

### 复赛数据

比赛所用的训练集将提供行人/车辆的原始图片，参赛队伍需要基于大赛提供的训练集进行模型训练与调优，选手提交模型文件和推理代码，由系统在给定的测试集上运行结果。

#### 训练集（提供给参赛选手）

含有 293,955 个图片文件，每个图片文件提供 ID 标签，可以用于模型训练。

标注文件将由文本文件提供。文本文件每一行提供一个标注。

文件组织结构如下：

train

├── train_picture

└── train_list.txt

#### **复赛测试集**

复赛测试集由 gallery 与 query ，特征文件 组成，其中 query 包含 49,998 张图片文件（每张图片ID不同），gallery 包含 959,029 个图片文件，即查询范围是 959,029 张图片，特征文件包括3万张同源图片的视觉特征文件。

复赛测试集仅用于参赛队伍模型评测，不提供下载

### 复赛最终结果

得分：7.18

排名：51

## 项目开发流程

1. 2022.2.14-2022.2.19 第一周

   任务：给定2048维的特征文件与压缩字节要求，实现压缩解压缩的方法

   思路：首先实现简单的PCA方法，搭建代码框架，从而能够在初赛提交平台上通过运行测试；之后使用深度学习模型，进一步减少重建特征的误差以及提高重建特征的泛化能力，为复赛阶段重建特征的重识别任务铺垫。

   第一阶段：调用scikit-learn库中的PCA包，得到较为理想的效果；为了进一步提高性能，我们将压缩格式由float32改为float16，因为精度下降带来的误差远小于模型由于维度提升提升的性能，取得了十分理想的结果，在压缩维度64，128，256三个指标中，均得到相似的重建误差。

   第二阶段：使用autoencoder模型，得到更小的重建误差，同时也采用了之前更改压缩格式的方法，进一步提升了模型性能。

2. 2022.2.21-2022.2.25 第二周休息

3. 2022.2.28-2022.3.4 第三周

   任务：熟悉近几年常见的重识别任务模型，并熟悉复赛代码结构，提交一版代码在复赛平台上跑通，包含提取、压缩、重建与重识别四个任务

   思路：根据大赛官方提供的示例代码，并将autoencoder压缩解压缩模型整合一起。

4. 2022.3.7-2022.3.11 第四周

   任务：搭建fastreid运行环境，配置本地电脑运行环境，熟悉fastreid代码结构

5. 2022.3.14-2022.3.19 第五周

   任务：将fastreid代码整合到第三周实现的复赛代码中，并根据复赛数据的分布对模型进行针对性训练

   思路：为了更好的训练fastreid模型，采用了打乱图片rgb三个通道的方法，进而扩增训练集

## 项目代码结构

naic2022semi-final

├── gallery_feature	example of gallery feature data

├── query_feature	example of query feature data

├── reid_results	重识别结果样例

├── README.md	README file

├── 项目总结	该项目的总结与汇报

├── example.py	代码运行样例

└── project

​		├── AEmodel	autoencoder模型文件

​		├── configs	fastreid配置文件

​		├── datasets	fastreid训练数据

​		├── docs	fastreid模型文档

​		├── fastreid	fastreid内核代码

​		├── logs	fastreid模型文件

​		├── tools	fastreid运行代码

​		├── AE.py	autoencoder代码

​		├── extract.py	特征提取代码

​		├── compress.py	特征压缩代码

​		├── reconstruct.py	特征重建代码

​		├── reid.py	重识别代码

​		├── format_data.py	生成fastreid训练所需的索引文件

​		└── README.md	fastreid README文件

## 项目技术细节

### 压缩重建模型的选择

autoencoder模型提供了较为方便的低维特征的提取与输入特征的重建，将损失函数设置为重建误差，通过选择中间的神经网络层与激活函数，能够得到较好的重建效果

### Fastreid运行环境的搭建

Fastreid模型运行环境受gpu型号、cuda版本与pytorch版本限制，经过多次尝试，我们发现如下配置可用

```
conda create -n fastreid python=3.7
conda activate fastreid
conda install pytorch torchvision torchaudio cudatoolkit=11.3 -c pytorch
pip install -r docs/requirements.txt
```

### Fastreid模型的训练

Fastreid模型的训练需要将训练集放到指定的路径，同时需要根据数据集生成三个文件用于训练，分别是sub_train_list.txt, val_query_list.txt, val_gallery_list.txt，文件中每行为训练集中的数据文件名，同时val_query_list.txt中的文件名需包含在val_gallery_list.txt之内。

我们将随机从训练集中提取200000个特征文件，放到sub_train_list.txt中；从训练集提取30000个特征文件放到val_gallery_list.txt中，并从30000个特征文件中提取10000个特征文件，放到val_query_list.txt中。值得注意的是，这两个文件包含的特征数目不宜过大，对运行的内存要求较高，在30G到50G左右

### 模型训练过程

由于本地内存有限，无法进行fastreid训练代码中的交叉验证，需要到配置文件中修改训练配置，将交叉验证的周期调大

### Fastreid模型推理的配置

Fastreid源码提供给我们较为方便的路径设置，我们只需要在config/中寻找对应的配置文件进行修改，但是测试集数据路径结构和复赛要求的路径结构不同，这要求我们去修改fastreid源码。

为了自定义fastreid测试集路径，需要到project/fastreid/data/datasets/naic2021_reid.py中修改实现方法，从而给定配置文件中的测试集路径，fastreid能够自动找到需要的文件

同理，最终重识别任务的输出也需要修改源码，从而满足复赛的要求

### Fastreid主干网络的选择

与平时的重识别CV任务不同，复赛重识别任务得到的只有2048维的特征向量，而非常见的维度为[width, height, channel]的图像。由于时间的限制，我们未对2048维的特征向量进行过多的处理，例如将其还原为与原数据较为相似的图像，而是使用了MLP的主干网络。在未来可以考虑对特征提取函数extract.py进行修改，从而能够使重识别任务能够重新处理得到与原数据较为相似的图像，进而使用性能更强的主干网络，例如ibn，resnest，这些主干网络的配置文件已经添加在代码中，以待后续的开发。

## 项目后续发展

该项目具有广泛的应用前景，在未来考虑将其进一步的优化与封装，对模型与训练细节进行修改，做成产品进行实际应用。
